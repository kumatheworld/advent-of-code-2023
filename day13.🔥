import math


fn find_mirror(
    pattern: String, horizontal: Bool, width: Int, height: Int, smudge: Int
) -> Int:
    let sv: Int  # vertical stride
    let sh: Int  # horizontal stride
    if horizontal:
        sv = width
        sh = 1
    else:
        sv = 1
        sh = height

    for i in range(1, height):
        var counter = 0
        for ii in range(math.max(0, 2 * i - height), i):
            for j in range(width):
                let x = pattern[sv * ii + sh * j]
                let y = pattern[sv * (2 * i - ii - 1) + sh * j]
                if x != y:
                    counter += 1
                    if counter > smudge:
                        break
            else:
                continue
            break
        else:
            if counter == smudge:
                return i
    return -1


fn solve(s: String, smudge: Int = 0) raises -> Int:
    let patterns = s.split("\n\n")
    var total = 0
    for i in range(len(patterns)):
        let pattern_with_newlines = patterns[i]

        var width = -1
        for j in range(len(pattern_with_newlines)):
            if pattern_with_newlines[j] == "\n":
                width = j
                break
        let pattern = pattern_with_newlines.replace("\n", "")
        let height = len(pattern) // width

        let mirror_h = find_mirror(pattern, True, width, height, smudge)
        if mirror_h > 0:
            total += 100 * mirror_h
        else:
            let mirror_v = find_mirror(pattern, False, height, width, smudge)
            total += mirror_v

    return total


fn main() raises:
    print(solve(example))
    print(solve(text))
    print(solve(example, smudge=1))
    print(solve(text, smudge=1))


alias example = """#.##..##.
..#.##.#.
##......#
##......#
..#.##.#.
..##..##.
#.#.##.#.

#...##..#
#....#..#
..##..###
#####.##.
#####.##.
..##..###
#....#..#
"""

alias text = """##..##..##.
######..###
.####.##.##
..........#
.####.##.##
.####....##
..##..##..#

##.##.#.#..##
##.##.#.#...#
.#.###......#
.###.##..#..#
##.#.##....##
.#..###.###.#
.#...#...#.##
#.#.##.#...##
#.###.#.##.#.
#.#.#...####.
#.#.#...####.
#.###.#.##.#.
#.#.##.#...##

.........#.##
...........##
..###....##..
##.##.#..#..#
####....####.
##.####.#####
....##.#.....
##.#..##..#.#
###...##.....
##..##..###..
......######.
###.##.#####.
...#.##.#####
##..#..#.##.#
#####..#..##.

.#....########...
.##.....####.....
.##.....####.....
##....########...
..#..##..##..##..
####.###.##.###.#
#.######....#####
..#.#...####...#.
....##.#.##.#.##.
#.#...##.##.##...
.#.##..##..##..##
#.##.#.#.##.#.#.#
.#.#....#..#....#
.#...###.##.###..
##.###........###

..###..##..
.#.#.....##
#.##..##.#.
#.#..###..#
.#..##.##.#
.#....##..#
#.####.##.#
#.####.##.#
.#....###.#
.#..##.##.#
#.#..###..#
#.##..##.#.
.#.#.....##
..###..##..
..###..##..

####..#
#...#.#
.##.#.#
.##.#..
####...
.##.###
.##.##.
....###
.##..#.
......#
####..#
######.
####.##
####...
####...

#####.#..
#.#......
#.#......
#####.#.#
#####.#.#
#.#......
#.#......
#####.#..
.#####...
#..#...##
#.#..##..
####.####
#...##...

.#.##.....#.#..
....####.##.###
#.#..#...###...
.###..#.###...#
..###.##..###..
...#..#.....###
...#..#.....###
..###.##..###..
.###..#.###...#
#.#..#...###...
....####.##.###
.#.##...#.#.#..
.#.##...#.#.#..
....####.##.###
#.#..#...###...
.###..#.###...#
..###.##..###..

#......
..#.##.
##.#...
.##..#.
.##..#.
##.#...
..#.##.
#......
#......
..#.###
##.#...

.##...###
......##.
.##..##.#
#..#.#..#
....#.###
#..#.#..#
.....#..#
######.#.
######.#.
.##..##..
.##.....#
#..#.....
#..#.#...

.#..#.###.#..##
.#..#.###.#..##
#.##..#..####..
#.#####..#..#..
#..#..#.#...###
..#.##.##.##.##
..#..##.#.##.##
####.##...#..#.
..#...#..#.#...
###.#.#..#...##
.#..#######..##
###.#.#.###....
.#.....#.....##

##.#.#..#.##.#..#
.####..##....##..
#.##.#.##.##.##.#
#..#..#..#..#..#.
###.#############
#.##.............
...####..####..##
..#..##..####..##
#.#.#.####..####.

#..#...
..#.##.
#####.#
#..####
####..#
......#
....###
#..#.#.
####.##
####.##
#..#.#.

####...
##.#...
####...
.#.#...
##.####
##.##..
#####..
##.#.##
.##....
.##.###
##..#..
#..####
#...#..

.#.##.#..
.#....#..
#......##
##.##.###
..####...
#.#..#.##
.##..##..
........#
...##....

###.#.##...#..#..
###.#.##...#..#..
#....#.#.###..###
.####.#.##......#
#####.#.##.####.#
#.##....#...##...
...#.###...#..#..
###...##..#####..
##..#.###........

#....######....#.
#....#.##.#....#.
..##........##..#
.##.#..##..#.##..
#....##..##....##
..##..####..##..#
.#..#......#..#..

..#..#.
#..#.#.
#..#.#.
.....#.
##.....
.####.#
.####.#

####...##..##..
####.####.####.
..#.#.##..####.
..#.#.##..####.
####.####.####.
####...##..##..
.###.#.##.#.##.
####.#.##.####.
#...#.##.......
#..###.##.####.
.#...#####....#
####.###.#.##.#
.#.###.###....#
..#.##..##.##.#
#.###..#.#.##.#

##.###..##.
.####......
.####......
##.###..##.
######..##.
.#.##......
.##..#.#..#
#.#...#..#.
#.#.##.....
###.###....
...#..#.##.

.......#.####
.......#.####
#..##........
.#...###.##.#
##.#.##.#####
#.#####...#.#
.#.###.####.#
..###....#..#
#.#.####..##.
#.#.####..##.
..###....#..#
.#.###.####.#
#.#####..##.#
##.#.##.#####
.#...###.##.#
#..##........
.......#.####

#....##.###
#.#.#.#.#..
#.#.#.#.#..
#....##.###
#.#...#.#.#
.#......##.
.#..#.##...
....#..#..#
.###.##.##.
.###.##.##.
....#..#..#
.#.##.##...
.#......##.
#.#...#.#.#
#....##.###

.#....#.##.
..#...#....
####...####
..#.#######
.##...#....
#.###.#....
#.###.#....
.##...#....
..#.#######
####...####
..#........
.#....#.##.
#.#.#.#....
.#.##......
.##..#.#..#
#..##......
#.######..#

.###.#.####.#.#
#..##...##...##
#..##.##..##.##
.###.#......#.#
##..##.####.##.
....##.####.##.
.#...########..
...#...####...#
..##..........#
..##....##....#
..###.#.##...##
.#.###.#..#.###
.###...#..#...#
##.#####..#####
##..#........#.
#######.##.####
#######.##.####

###...##......#
###....#......#
#..#.#.#......#
..##.##........
#.#...#.##..##.
###...#########
.#...###.####.#
..#..#...#..#..
..#.##.##....##

.##..#..###.#.#
.##..##.....##.
....###.####..#
.......###..#..
######..#.##..#
.##..#.#####.#.
.##..#.###.#.#.

..##.##....##
#.##.#....##.
#....##.#.##.
######.#.####
######..#....
#....#..#..##
.#..#.####...
.####.##.#...
.####.##.#...

#...##...#.#.
#..####..#.##
#........#..#
.#.####.#..##
..##..##..###
#.####.#.#..#
##.#..#.##.#.
...####...##.
#.######.#.##
#.##..##.#...
.##.##.##..#.
.##.##.##....
#.#.##.#.#.##
#........####
############.
##.####.##.##
##.####.##.##

.#....##...
...#......#
##.##....#.
...#......#
..#.#....#.
#..##....##
###.######.
.###......#
#.#..#..#..
..#.#....#.
..##.#..#.#
..##......#
####.####.#
#..###..###
#.###....##
..###.##.##
..###.##.##

#.....#.#....#.#.
##....#.#....#.#.
#.##.#.###..###.#
.#.##.#..#..#..#.
###...##.####.##.
#.###.####..####.
#.#.....######...

##.#..#.###
...####...#
###....####
###....####
...####...#
##.#..#.###
#.##.###.#.
..#.##.#..#
##......##.
..######...
#.#.##.#.##
#.##..##.##
..######..#

#####.##...##...#
#..##.###.##.##.#
.##..#.#.......##
....####.#.##.##.
#..#..#..#...##..
#..##.##.#.#.##.#
#..##.##...#.##.#

..#.#.####.#.#.
##.####..####.#
##.#........#.#
..#....##......
#####......####
..#.#.####.#.#.
..#.#.#..#.#.#.
...##..##..##..
..#.#......#.#.

..#.###.##.##
##.#.##...###
..#####..#.##
####..####.##
##...#.#.....
.##...#.##...
####....###..
##...###..###
..#..##..##..
##.##.#.#..##
####.#..#.###
...###.#.####
...#..#.##.##
##.....#.....
...########..
#####...##...
##.#.#....#..

...##.##.
###.#####
..######.
##.#.....
...#.####
##.###..#
##.#.#..#
..##.####
..#.#.##.

.##....##..#..#
####.#.#....##.
#.#....#..##.#.
#..#...###..#.#
#.#.###..#####.
.#...#....#...#
.#...#....#...#
#.#.###..#.###.
#..#...###..#.#
#.#....#..##.#.
####.#.#....##.
.##....##..#..#
.##....##..#..#

..##.......
.####..###.
......###..
......###.#
..#....#..#
##..##..#..
.####..##..
..##..#..#.
#....##.#.#
#....##.#.#
..##..#..#.
.####..##..
##..##..#..

###.##.######
....##.......
##..##..####.
..#.##.......
..#....#....#
#........##..
###....######
..#....#....#
.#.####.#..#.
#.##..##.##.#
.#.####.#..#.
.########..##
#.##..##.##.#

###....####..#.##
##.#..#.#####.###
....##....###..##
...#..#....#.##..
.########..#.....
..######...######
.#..##..#..#.#..#

#####.##.##..
....##..#.###
.##...###.#.#
.##..#..##...
.##.#..#..#.#
#..#...###.##
....#..##..##
#####....##.#
......####...
.##...##..###
.##.####.###.
....##...##.#
....##..#...#
.##.#..####..
####.####....
.##..#...#.#.
.##..#...#.##

##.#....##....#
.#.###.#..#.###
.##.#.##..##.#.
.###.##.##..#.#
..##..#.##.#..#
...#.#......#.#
.#.###......###
.##..#.#..#.#..
...#.##....##.#
######..##..###
..#.#..####..#.
##...##.##.##..
#.#####....####
#.#####....####
##...##.##.##..
..#.#..####..#.
######..##..###

##.##....
###......
....#.#..
#..#.##..
#..#.##..
....#.#..
#.#......
##.##....
#####..##
##..#.#..
####.##..

#.#....
#.....#
.###..#
.###..#
#.....#
#.#....
#.##..#
#...###
##.#...
..##.##
##..#..
..#...#
..#....
##..#..
..##.##

#..#.##.....#
#..#.#....#..
.##.###....#.
.##.###....#.
#..#.#....#..
#..#.#......#
#..##....##..
.##.....####.
#..##..#...#.
.##.#..#...#.
#..#..#......
.##..#.##.#..
.....#####.#.

..#.#..##
###.####.
...#..##.
.....#.#.
...##...#
.....#.#.
####.....
#####....
.....#.#.

#..#####..#
#......###.
#......###.
#..#####..#
######.....
#.##.....##
..#####.##.
###......##
###.....###
..#####.##.
#.##.....##

.#.....#.#.
...#.###.##
...#.######
.#####....#
##.#..#..##
##.#..#..##
.#####....#
...#.######
...#.###.##

..#......
##..#.#.#
#.#.#.#.#
#.####..#
.##...##.
.#....##.
#.####..#
#.#.#.#.#
##..#.#.#
..#......
..#......

.#####.#..####.
#..#..#...####.
##.###..#..##..
#..###..#..##..
#..#..#...####.
.#####.#..####.
#.........####.
#.####.###.##.#
..#.###....##..
#.#.#..####..##
#..##.##..####.
.....#.####..##
###.......####.
..#...#........
###.#.##.######
###..###...##..
...#...##..##..

..#.##.....#.#.
.####..##..####
.#....####....#
#...###..###...
..#.##....##.#.
..#.##....##.#.
#...###..###...

#........##.#.###
.#.##..##.....#..
.#.#.#.#.####..#.
.#.#.#.#.####..#.
.#.##..##.....#..
#........##.#.##.
#.#.###.#....#...
#.#.###.#....#...
#........##.#.##.
.#.##..##.....#..
.#.#.#.#.####..#.

..#...#####
#.##...##..
##...##..##
##...##..##
#.##...##..
..#...#####
#.####.#..#
...#..###..
#..##.##.##
#.##.#..###
.###.##.#..
.#.#...#.##
#..###..#..

....#...####...
..##..##.##.##.
##..##..####..#
.#..###.#..#.##
..###.##....##.
...###..#..#..#
...#.#.######.#
..##..##.##.##.
##..#...####...

....##.....##.#.#
#.#....#.######..
############..###
#.##..##.#.####..
#.##..##.#.####..
############..###
#.#....#.######..
....##.....##.#.#
#.#.##.#.#.#..###
#.######.##.####.
#######.##.#.#.#.
#.######.#..##.#.
..#.##.#......#.#
..#.##.#..##...#.
.##....##.##..#..

##..#...##...####
##..#...##...####
###......#.......
.##.##..##..#.##.
.#.#.#.##....#..#
##..#.#.#..##.##.
#..####...##..##.
##.#....###.##.##
.#...###.####....

..#.#..######..#.
..#.#..######..#.
..#..##.......#..
...#.#.######.#.#
##...#.#....#.#..
#.######....#####
#..####..##..####
......#......#...
#...###.####.###.
....#.#.#..#.#.#.
#..#.###.##.###.#

..########..#
...#.#.##....
##.###.#..##.
###.#.#.#...#
##.##....##.#
...###.####.#
###...#.###..
###...#.###..
...###.####.#
##.##....##.#
###.#.#.#...#
##.###.#..###
...#.#.##....

##....#..#.
##.#.#####.
##.###.##.#
#...###.##.
#####..#..#
##.##.#####
..#..#####.
...#.##.#.#
...#.##.#.#
..#..#####.
##.##.#####

.#.....#.###.###.
##..##.#.###.#.#.
##.###.#.###.#.#.
.#.....#.###.###.
..#....#.......##
...###.#.#..#...#
##.####.#.##..##.
...#.##.##...##.#
..##..#.##......#
..##..#.##......#
...#.##.##...##.#
##.####.#.##..##.
...###.#.#..#...#

.###....##...
##....##..##.
###..##.##.##
...#..#....#.
#......####..
.#.##...##...
.....#.####.#
#.####..##..#
#.####..##..#
.....#.####.#
.#.##...##...
#......####..
......#....#.
###..##.##.##
##....##..##.

...#.##
#.###..
#...###
#...###
#.###..
...#.##
.#.####
#.###.#
.#..###

#.#..#.####
.#....#.###
########.##
.##..##....
#......#..#
.#....#..#.
#.#..#.##.#
.######....
.##..##..##
##....####.
##.##.###..
#..##..####
#......#..#
##.##.###..
.##..##...#
.##..##...#
##.##.##...

.#.#.####....#.#.
..#.##..##.#.##.#
##..###....###.#.
..#..#..##...####
.##..#..####..###
.####.##...##..##
.####.##...##..##
.##..##.####..###
..#..#..##...####
##..###....###.#.
..#.##..##.#.##.#
.#.#.####....#.#.
.#.####.#...#.###
...#.##.#.####...
...#.##.#.####...
.#.####.#...#.###
.#.#.####....#.#.

#####.#..#.##
.##..#.###..#
......##.####
#..#.#...####
#..#.#...####
......##.####
.##..#.###.##
#####.#..#.##
#..#.#.##...#
.##....##...#
#..###..#...#
#..#..####...
########...#.
#..#.#..#####
.##..#...#..#

#.#..##..####
.#.#.########
####.#.......
.......##.##.
.#..#.#......
######...#..#
.##.####.....
.##.####.....
######..##..#
.#..#.#......
.......##.##.

...#.###..###
#.#####.##.##
#.#####.##.##
..##.###..###
##.####....##
...##########
#.....##..##.
.#....#....#.
..#.#..####..
.#....#....#.
.###...####..

#######.#....
#######.#....
.####..#..##.
#....##..#.##
##..#########
..##..#####..
...#..#.####.

#..####..
#..#.##..
.....##.#
#######.#
####.###.
######...
#..#.####
.##..####
.##.####.
.##....##
....#....
######.##
.##.###.#
#..#...##
....###.#
#######.#
####..#..

..##.#####....##.
..##.#####.#..##.
..##...#..######.
#....#.#..#.#..#.
###.#...#.##.##.#
.##..####...####.
#....###..#..##.#
....#....#.##.#..
..#...#####.###..
#.#......#.#.#..#
..####.#..##..##.
..#####.##...#..#
.#####..#....#...
...#...#...#.##..
...#...#...#.##..

##..####...#.##.#
##..##.#...#.##.#
.####..###.#.#..#
##..#####.#...#.#
#....######..##..
#....#..###......
..##..##.##.#.#..
#.##.##..#...#.##
.......##.....##.
#######.####.#..#
#.##.###.####.###
.#..#...#..#.##..
##..##.#.####.#..
#.##.#..#..###...
......#.#.#.#.##.
........#.####..#
..##...#.##..#...

#.##...#.
#.#..#..#
#....##.#
.#.#...##
.#.#...##
#....##.#
#.#..#..#
#.##...#.
#...##.##
.####...#
.####...#
#...##.##
#.##...#.
#.#..#.##
#....##.#

#####.#...#..
#####.#...#..
.##..###.#...
.##.#.....#..
#.#.#.##.#..#
.###.########
...#.###....#
.#####..#.##.
#.#...###..#.
..#.#........
..#.#......#.
#.#...###..#.
.#####..#.##.

#.##.#.#.##
#....##....
.####.###..
.####.###..
#....##....
#.##.###.##
######.###.
##..##....#
#.##.##.###
########..#
#....##..#.

..###..##..
.#.#.##..##
.#.####..##
#...#######
.####......
#......##..
##.....##..
....#......
....#......
#...###..##
.##.##.##.#
##..#......
#..#.######
#.###..##..
.#..#......

##.#..#..#.
#......#.#.
#.####....#
.#..#..####
####.....##
####.....##
.#..#..####
#.####....#
#......#.#.
##.#..#..#.
..##..#.#..
...#.##....
.##..##.###
###..##.###
...#.##....

....#..#.##
......#..##
#..######.#
#..#..#.#..
######.####
.##.###.#..
.##.#.#....
#..##...###
....#..##..

#.###.#.#..#.
#....###.##..
#...#.##.##.#
.....#.#....#
##...########
.##...##.##.#
..####..#..#.
.###...######
.#.#.##.####.
..##.........
..##.........
.#.#.##.####.
.###...######
..####..#..#.
.##...##.##.#
##...########
.....#.#....#

#...##.#....#
#..###.#....#
##.....##..##
#.#..####..##
#...#..#....#
###.#.#######
####.##.####.
####.#.......
#....##.#..#.
.##.#.###..##
#.#..#..#..#.
#.#..#..####.
..#...##....#
.##.#..##..##
####.###.##.#
.##..#.......
...##..######

##.#..###
##.#.####
.##.#.###
.#.#.##..
.#..#####
...###...
#....##..

.#..####..#
#...#..#...
#...#..#...
##..####..#
.###....###
....#..#...
.#.##..##.#
##.#.##.#.#
#..........
.##.#..#.##
#..#.##.#..
.....##....
.#..####..#

##.#..#.#
...####..
..##..##.
..##..##.
###.##.##
.########
....##...

###.####....##.
###...#...##.##
...#.#.#...#.##
##...#....##.#.
###..###.......
......##..####.
##..######..###
##..######..###
......##..####.
###..###.#.....
##...#....##.#.

###.####.
#....##..
.#..#..#.
#....##..
..##....#
#....##..
##..####.

#..#.######.#
.#.##......##
#.#....##....
..#####..###.
..#...####...
....#......#.
.##...####...
.#.##.####.##
..#..##..##..
.##...####...
#.####....###
##...######..
#..##.#..#.##
#..##.#..#.##
##...######..

.........##
........#..
##....#####
#.####.####
..#..#..#..
##....###..
.#.##.#.#..
#......##..
#.####.####
...##.#....
.######....

.##.######.##.#
..###....###..#
#.#.##..##.#.##
###........####
###........####
#.#.##..##.#.##
..###....###..#
.##.######.##.#
.#.#.####.#.##.
..##########..#
.#.########.#.#
.#..#.##.#..#..
#..#......#..#.

.#.#..#
.###..#
..#....
#.##..#
#.#####
..#....
#..####

##..#..####..#..#
..###........###.
##..###....#.#..#
#..##.#.##.#.##..
##..###.##.###..#
..#...##..##...#.
###.#.#....#.#.##
#.#.#.#....#.#.#.
##...#......#...#
#...#.#....#.#...
#...#.#....#.#...
##...#......#...#
#.#.#.#....#.#.#.
###.#.#....#.#.##
..#...##..##...#.

#..##.#.#
.#...##..
.##.#..#.
.##.#..#.
.#..###..
#..##.#.#
.######.#
#.#..#...
#.#..#...

.#..#.#.#..#.....
#....#.##.#......
#....#.##.#......
.#..#.#.#..#...#.
.#..#...#..###...
#....##.##.#..#.#
#.##.#..#..#.##..
#....#####..##.##
#....###.########
.####.##..##.....
..##.......#.....
######.#.#.#.#.#.
......##.###...##
.####.#.##.#.#.##
#....#..##.#..###

#..##............
.##.####..##..###
.##..#.#.####.#.#
......#.#....#.#.
......##########.
#..##.###..#.###.
......##.####.##.
.##.##..........#
.##..#####..#####
....#...#.##.#...
.##...#..#..#..#.

....#.##.#.##.#
.##.##.########
#..##.####.##.#
.##.###.#.#..#.
#####..##.#..#.
.##...#.###..##
.#...#....####.
.....##....##..
####.####.####.
#####...##....#
......#.#..##..
#####...##....#
####..####....#

.#....#..#..#
.#.####.#.##.
###..#####..#
.##..##.#....
..#..#..#####
#......#.####
#......#.....
...##...##..#
##....##.#..#
##....##.....
#.#..#.#..##.
###..###.....
.######.##..#

......##..#
....#.#.##.
..#.#......
.#......##.
.###..##..#
.###..##..#
.#......##.
..#.#......
....#.#.##.
......##..#
##.#.#.#.##
.#.###.....
####..#####

##...#######.#.##
##..###...#.#....
...#.####.#..#...
##.#...#.#...####
####..#.##..##.##
....#####.#.####.
##.##..#.#.#.#...

..#.#...#.#.##..#
.##..#...##.#.#..
#...##.#..#..##..
#..#.#.#..#.#####
#...##.###.#.###.
##..#.#.##...#..#
##..#.#.##.##.###
####.##.#.#...##.
.....###....###..
#.##.#.##..#...#.
.#..#.#....###..#
#.#.####.#.#.#.#.
#.#.####.#.#...#.
##.###.##.##.....
##.###.##.##.....
#.#.####.#.#...#.
#.#.####.#.#.#.#.

######.#.#..#.#
##..###........
#.##.#....##...
.#..#.####..###
..##..###....##
......#........
#....###.####.#
......#.##..##.
#.##.##...##..#
#....##.##..##.
#.##.#.........

####.##.#
.##....#.
...#####.
...#####.
.##....#.
####.#..#
####.#..#

.###..###.####.
###.##.####..##
#........######
#.#....#.######
#.##..#..######
##.#..#.##....#
.#..##..#......
#.#.##.#.##..##
###.##.####..##
..#.##.#...##..
..######.......

#...##..#
#...##..#
..######.
.#.###..#
#...####.
.#..###..
#....#..#
#.#.#....
####..#.#
####..#.#
#.#.#....
#....#..#
.#..###..
#...####.
.#.###..#
..#####..
#...##..#
"""
