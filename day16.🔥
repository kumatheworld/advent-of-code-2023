from math import max


struct Grid:
    var width: Int
    var height: Int
    var grid: DynamicVector[DynamicVector[Int]]  # height x width
    # The size 4 corresponds to the directions (right, bottom, left, top) in this order
    var history: DynamicVector[DynamicVector[DynamicVector[Bool]]]  # 4 x height x width
    var di: StaticIntTuple[4]
    var dj: StaticIntTuple[4]

    fn __init__(inout self, s: String) -> NoneType:
        var width: Int  # Could conceivably be let
        for i in range(len(s)):
            if s[i] == "\n":
                width = i
                break
        else:
            width = -1  # Should never happen
        let height = len(s) // (width + 1)
        self.width = width
        self.height = height

        var grid = DynamicVector[DynamicVector[Int]](height)
        for i in range(height):
            var row = DynamicVector[Int](width)
            for j in range(width):
                let c = ord(s[i * (width + 1) + j])
                row.append(c)
            grid.append(row)
        self.grid = grid

        var history = DynamicVector[DynamicVector[DynamicVector[Bool]]](4)
        for _ in range(4):
            var mat = DynamicVector[DynamicVector[Bool]](width * height)
            for _ in range(height):
                var row = DynamicVector[Bool](width)
                for _ in range(width):
                    row.append(False)
                mat.append(row)
            history.append(mat)
        self.history = history

        self.di = StaticIntTuple[4](0, 1, 0, -1)
        self.dj = StaticIntTuple[4](1, 0, -1, 0)

    fn forward(inout self, d: Int, i: Int, j: Int) -> NoneType:
        if not (0 <= i < self.height) or not (0 <= j < self.width):
            return

        if self.history[d][i][j]:
            return

        self.history[d][i][j] = True
        let di = self.di[d]
        let dj = self.dj[d]
        let c = self.grid[i][j]
        if c == ord(".") or (c == ord("|") and di) or (c == ord("-") and dj):
            self.forward(d, i + di, j + dj)
        elif c == ord("|"):
            self.forward(1, i + 1, j)
            self.forward(3, i - 1, j)
        elif c == ord("-"):
            self.forward(0, i, j + 1)
            self.forward(2, i, j - 1)
        elif c == ord("/"):
            self.forward(3 - d, i - dj, j - di)
        elif c == ord("\\"):
            self.forward((5 - d) % 4, i + dj, j + di)

    fn count_energized(self) -> Int:
        let h = self.history
        var total = 0
        for i in range(self.height):
            for j in range(self.width):
                for d in range(4):
                    if h[d][i][j]:
                        total += 1
                        break
        return total


fn solve1(s: String, d: Int = 0, i: Int = 0, j: Int = 0) -> Int:
    var grid = Grid(s)
    grid.forward(d, i, j)
    return grid.count_energized()


fn solve2(s: String) -> Int:
    let grid = Grid(s)  # Do this just for the sake of width and height
    var largest = 0
    for i in range(grid.height):
        largest = max(largest, solve1(s, 0, i, 0))
        largest = max(largest, solve1(s, 2, i, grid.width - 1))
    for j in range(grid.width):
        largest = max(largest, solve1(s, 1, 0, j))
        largest = max(largest, solve1(s, 3, grid.height - 1, j))

    return largest


fn main():
    print(solve1(example))
    print(solve1(text))
    print(solve2(example))
    print(solve2(text))  # Very slow but will run. Parallelization will help.


alias example = r""".|...\....
|.-.\.....
.....|-...
........|.
..........
.........\
..../.\\..
.-.-/..|..
.|....-|.\
..//.|....
"""

alias text = r"""\|.....-.....\....../.....-....................................../....-.............|.......|....|...\........
...............|...|...........-............../......../..|.........|..../....-.-.|...........|..............|
.........|....\......-..............................|.....\..........\........../.../...../..\...........|....
...-................................................./.-...-..................../....../..|....|..............
\...|...|-.............................................................................-.................--|..
...............|.....|.......\..|.....-................................|.........../............/.........../.
.\....\............./............|...........\...|.....................\.-.\......-............|...........\..
./..........................\..\.........|.-...............................|........|..-....-............/....
............/....................-........../.....................................-.................|.........
..................................|/....-......................|............./...............\...............-
............|||.....\....|....|.........-................\..............\.................-...............\...
......-...........................-.......\.....................-..............-...|....\.....-...............
./............/.-|.\/.......-./\........\..\-.............../....-.....-........././...........|............\.
.-..-.............-\...............................|....\......||/.......|....../...|.................\.......
..|/..............................|.|............../........-..........\/......./.......--...........|........
...-/.....\........\...|.................................\.../.................\-......../...........\........
................-...|............/........./\\.................../......../|.........../.........|-..\........
............\............./\....................|//.......|-|...-/........\..............................-....
..................|...../..................\..|.........\.............|...................|........\...-...|..
........../................../............................./.........|.................\...............-\../..
.../...........\....|.................\.........................................../.......................//..
/..\..................................\....|.................|..-....|......................|.....|...........
.....-.......\.........-.-.....|.................\-.............|........./................/.\-.........|.....
.........-....-...................../..//...../....../..........|......./../.........--....-......\..../......
.....\\............................./.../....../...../......./.........../..-..........|-.....................
.............|.|........................../.......-......|..-..........|.............\..................../../
.../...../..\.........|.........................\.....\....-...........-.....\....................\...........
..................../........./.|....|............................../......-..../................./...|.......
..........................|....|...\.............\..................-.....\-..................................
......\...\......./..\.-.....-.......-...|...........-.........\.-....../...-.../................-............
.....................\.........................|.............................-...\............-.../...........
...../\...-../..|................/............../...........|/.-........-.................../.......-.....-...
...../.......|...............................................................................|....-......\....
-........................../....|.....\.................|......-/...................|...|/....................
..|...\...............-.............\.........../...../\.....|...........-..-.\....../....../...........|.....
....../...-..\...........\....../......|...\............../.................-...............|.\.-.............
../........|......../....../..|..........................\......-.............\.|.\...|/...../|...............
......|.......\-....\...|........-.........|.....|.....\--................-............\..................|...
|......../.......-.\....\...........|...................|......|...../...|..|........\....\....../............
......|..............-../..\..../................./.......\.......\...\......../...../........................
.-........................|.../...|...........|.......\...........|.\........................-............/...
............................../\..........-.|.//..............................|/.........\..................|.
.........................../................/......................../..........|...................\./.......
.....|....../...../............../.....-.|./\............|.....................|..............\...............
.....\|.........\./.../.......|.\................../..........-............/......\...................-...|/..
....--.........//.....-\........................\//.....-|......|./.............\...............|-.../......|.
.\....................................../..........-..\....\...\...|..................-.......................
../\............|....|\.|\................/............|.../...............................\......../.--......
....................-............/....|.|....||.....................|..........|./...\...--...../....\....|...
......-....|.................-.-.....|................|........../........\...|.............|/...........\....
....................-...-................-./|./.............................-.............../.................
........|.-.........../..../..||.......\........../................................/..........................
.........|..-....-..-......./......|\......................-..........-...\...|....\.../..|..\........./......
........................\............/...........\.-..........\.\..|\.../.....\...........|.....|..../....\...
.......-.\.......................-.../.........................\/........\.\..|...............................
................./..-.|................-..\.......|....................\.......................|.....-........
./.-.....................|............./........||-......|......-../............-.....-.......|...-.|........-
.........-.\../................/....--...-................-....-................/......./.....././-../\.......
...|......\./.......\|....\....\....\.........../.....|..........|...................|................\....../
...|............\-.........................-................................../.......\.-..........//.........
..\....../...........................-...-....-.......-...............|..................../........./......|.
.././............................/............|...............-........|...............|.........-......\./...
.......-.....\............|.........-\..............-\-............/..\.../\.|..|..../........................
............|..-....\................................-...|-..-/...................-......./\............./....
........\...................\.|...|......................|.........../...\-..\...\..........................\.
........\......-.....|...-............./.......-...............\...-..-..........-.-................-......\..
..|..........\..............-.-..............\........../................/....................................
.....................\................../.........../..-...................-...\...................|.\..-.....
...........|.................|../....\........|...\-./...............|...........\...........\..............-.
...................................................................\............|..........................-..
............|..............\....|................|............-.....|....|.................\.........|..|.....
........................|......\..............-.../............-.|/.-........................\................
.......................|......../....../........-............-......./....................|....../............
.........-............\...........|....................\.......\.................\.\...../../-..............-.
.\.......\....-/...............-.......................-............................|.|......\....-.......\|..
....\..\..........................\/.\...|.............-.|..................../.......-.\/....|..............\
........................../.........|..-\...-......-....\.../.........-.../....-.......|...-............\.-...
.....\.........\......|........../.../.............|.....\../..|...........\.......................-......\...
|.........|....|../....\..................................\...../.........\............................\.\.../
-...../...\.............-...//...............\........\...|.-.....................\....|.....\...--...........
....|...-..-...|\.....-\..........|..............|........................-/.....-............./..............
.-.........................\../.......|............|..|.|..|.|....../.....|-../\.............\.../.\......\...
................\.........|...\...|....|..........|..........\................................-...............
.........../-\.....-/.....|.\./........-................/.-.....\...........\..........\......................
../..|\...|./............................../.|.......|....\...............|.................\................-
...-...............|.....|...-.........-.|........\.....-...........\...............-......-.|.\..............
................/.-.-.........................\.-..|.\................................................|....../
....................-..|...........|.......|.........-.\....................................-....../....-.....
.....................-..........................-.............................\.\....|...-...\...|..|.........
./\........-..................................|................|..........................|...\|......\.......
...\.......-..........-......................|...........................-...|................................
..................................././.....|....|........\|.....|..-...............\\.................-.......
.-.....././.......|...................-...................-................................................../
..-..|......../.....|...................\..../....................................|..\...-\................/..
..................|.........................../......\..-....\............|-/..-................\|../...\...-.
............../-..-..../............................../........|.......................................\./.|..
....\......\....|....................-....|........................-\...|........\......................\.....
.........|...........|.............................-..................\.\............/.../....................
.|..-.......................|...............|..-............../.\................./.....\......-..|...........
..-.../.......................................-/.........|........-.............-......\........./...\../.....
......................\/...............|................\../............-.........|......\....................
...........-|.................../...../\..../........|.....-............................/-.|..\\.../..........
.........\.......|......../......./.......\..|.....-..............|................................|..........
....................................|........|/.......-.......|.........|//...................................
...........|......\...../../....................\..\......................./..........-......-.....|..........
../................./..-.........................-..........\-|......./.....-.\.........\.....................
..............................\.......|....\.....................................................-....\....|..
.........-\...............\...../\......-.....\................./........................-....\...............
.|............................................-..../../\......................................./....\........\
-........-...........|............./..........-...............................-.......-..../..................
"""
