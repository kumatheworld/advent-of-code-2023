struct Garden:
    var width: Int
    var height: Int
    var id_S: Tuple[Int, Int]
    var plot: DynamicVector[Bool]

    fn __init__(inout self, s: String) -> NoneType:
        var width: Int  # Could conceivably be let
        for i in range(len(s)):
            if s[i] == "\n":
                width = i + 1
                break
        else:
            width = -1  # Should never happen

        self.width = width - 1
        self.height = len(s) // width

        for i in range(len(s)):
            if s[i] == "S":
                self.id_S = (i // width, i % width)
                break
        else:
            self.id_S = (-1, -1)  # Should never happen

        var plot = DynamicVector[Bool](len(s) - self.height)
        for i in range(len(s)):
            plot.append(s[i] != "#")
        self.plot = plot ^

    fn __getitem__(self, idx: Tuple[Int, Int]) -> Bool:
        return self.plot[(self.width + 1) * idx.get[0, Int]() + idx.get[1, Int]()]


struct Fresh:
    var width: Int
    var height: Int
    var fresh: DynamicVector[Bool]

    fn __init__(inout self, width: Int, height: Int) -> NoneType:
        self.width = width
        self.height = height
        var fresh = DynamicVector[Bool](width * height)
        for _ in range(width * height):
            fresh.append(True)
        self.fresh = fresh ^

    fn __getitem__(inout self, idx: Tuple[Int, Int]) -> Bool:
        let serial = self.width * idx.get[0, Int]() + idx.get[1, Int]()
        let value = self.fresh[serial]
        self.fresh[serial] = False
        return value


# Let's take advantage of the fact that the Elf will never reach the border
fn solve(s: String, num_steps: Int = 64) -> Int:
    alias di = StaticIntTuple[4](0, 1, 0, -1)
    alias dj = StaticIntTuple[4](1, 0, -1, 0)
    alias ddi = StaticIntTuple[4](1, 1, -1, -1)
    alias ddj = StaticIntTuple[4](1, -1, -1, 1)

    let g = Garden(s)
    var fresh = Fresh(g.width, g.height)
    _ = fresh[g.id_S]

    var q1 = DynamicVector[Tuple[Int, Int]]()
    var q2 = q1
    q1.append(g.id_S)

    var total = 1
    # 2 steps at a time
    for _ in range(num_steps // 2):
        for k in range(len(q1)):
            let i = q1[k].get[0, Int]()
            let j = q1[k].get[1, Int]()
            for d in range(4):
                # Axis-aligned
                let ij = (i + 2 * di[d], j + 2 * dj[d])
                let gijd = g[(i + di[d], j + dj[d])]
                if g[ij] and gijd:
                    if fresh[ij]:
                        q2.append(ij)

                # Diagonal
                let ij_ = (i + ddi[d], j + ddj[d])
                let gijd_ = g[(i + di[(d + 1) % 4], j + dj[(d + 1) % 4])]
                if g[ij_] and (gijd or gijd_):
                    if fresh[ij_]:
                        q2.append(ij_)
        q1 = q2
        q2.clear()
        total += len(q1)

    return total


fn main():
    print(solve(example, 6))
    print(solve(text))


alias example = """...........
.....###.#.
.###.##..#.
..#.#...#..
....#.#....
.##..S####.
.##..#...#.
.......##..
.##.#.####.
.##..##.##.
...........
"""

alias text = """...................................................................................................................................
...........#...........#..#....#...#.........#...##......#...................#.........#..#.....#.........#.......#......#.........
....#..#...............#.....#......#....................#........................#.....#............#..##.......#..............#..
...##....#.........#..#...#.#..............#.....#......#....................##....#..##.....##.............##.........###..#....#.
....#.#........#..#.....................#...................................##.............###..........#...#............##........
............#................#....#....#...........#......................###...................#.#.......#..#..................#..
.......#..........#.......#......................#...#......................#.#....#........#....#...#.............#...............
.#......#.........#.......#....#.#.............#...#.#.............#...........#.....#........#..................##.....#...#..#...
.......#..................#.....#..........##........#............#..........#..............###.....#.......#..#......#...#.#......
....#..#...##...#.#..###..#...##.#.#.#...#.#.......#...........................#....###..#...#.#....#........#......#.........##...
...........#......................##..#.........#..............#...............#...............##..##.#......#..............#......
.....#..#........#....#..........#............#.#.........#...........#............#......#.....#...#..#...#............#..........
..........##....#.#.....#..#........##....................#.#.....#...#................#..........###......#...##...#..............
......#......##..........#......#.......................##..#.............#................##........#.#.#.......#.#........#...#..
..........#....#.......#.......#.#.....#.......#...........#....#.#.....................#..........#.##...##....#....#.......#.....
......#......#.....##...........#....#...#............#.#...#............#............................#..........................#.
.#......###....#......#...#.....#.#..##..................#.............................##...#.....#..#...#.....#.#.........#....#..
.........#.....#.#...#....#..#.............##...............##.#.........#........................##........#..................#...
.#.#..#.........#.................#....#...............#....#.................#............#....#.....#...#......#....#.##.........
.........#...###................#......................#........................#.........#....#.......#...#.......#............#..
....#..#...#.#..###....#...##...#....#..#......................#...#..#.#....#............#....#.........#......#..........#....#..
....#.......#...##.....#...#..#...##..#.......................#......#....#....#.#..........#.#.##.....#.#.....#...........#.#.....
........#..........#..........#.......##.................#..........#......#....##............#..#.......................#..#.#....
....#.#......#..........#.............#.......###.#......##..##...#.##..#.....##.................##.##.......##.....#..#....###..#.
...#..#.......#.....##........................#........##...#.##..........#........#................#......#..#......#.....#...#...
........##..#...............#...##.............#..#.#.....#....#..#..#.....##....#............#..#......#...................#...#..
........##...#.#...#........#...##.........#..#................#..#.#...............#.#..............#..#..........#....#..........
.....##...#.....#...#........#....#.............................#.#.............##......#........................#........#..###...
..##...#.....#.#...#.#....#.....................#......#..#.......#.....................#..........#......#....#........#.#...#..#.
....##.##......#...........................##..#..........#........................#.#............#.#.....#..#.......##............
.......#.............#.#......##.........#...................#......................##...#.........##..............#.........#..#..
......#..........#......................#..#.........#.........#....................#...#...#........#....#..###..##.......#.......
.............##.......#...............##.....#...#..........#...........#..##...........#................#.....................#...
....##.##.....#......#.........................#................#.#........#........#......#..#.......##................#.#...#....
..#.#....#........#..#..............#.#........#..................#...............#.......#.................#.#.#.........#..#.....
.#..#......#..#....................#...........#......##....#.................#...............................##.#.#.....#.........
.......#.........#.#.................#....#.................#................#..#..#....#.#....................#...#..#..#.#.......
.....#..#......#..##................#....#..##.................#.........##..#......#.#....#...##............#.......#.#....##.#...
............#.#....#................#.........#...#............#....#...........#.....#...#.................#....#...#.##....#.#...
.........#....####..#......................#....#....#......................#............#.....#.#........................#......#.
..#........#..#.....#...........................#.......#...#.....##...#.....#..........#......#.....................#..#.......#..
...###....#.....#...........#.....#...............#.##.......#.........#...........#.#.............................#...#.....#.....
...#....##...................#....#........#.............##................................#...#.....#.#................##....#....
........#....#............#...##...##....##.###....................................##......#.##.#..#...............#...#....#....#.
............#.............##.#......#.#........#.#............#.#..#.......#.....#...##..#......#.##.#...............#....#...#..#.
...#.#..#.#...#...............................#...##..#............#...#...#.#....#....#..........#.......................##.......
.............................#......#.#..............#.....###.#.......#...............#..#......##.#......#.......#........#......
...#..#....#..#........................#.####...........#.#...#..............####.........#.....##......#...........#...#...#...#..
..#......................#..........##..........................#..............#........#..........#.#...........................#.
........#...........#............................#..#........#.#......#.....#...##..#......#...........##....#..............#..#...
....#...............#..#........#.#..#...#....#......#.........#..#...#.....##...#.#......................#................#....#..
.#.................##..........#.............#.#...........#..#.....#.............................#...........................#....
........................................#..#...........#.................#..#.##.#..#.#....#......#......#....................#.##.
...#....#.......#..#.#..........#................#...........#....................#..#......##...#...##....................#.......
......#................#....#...#.#................#...#.#......#.........#..................#......#....#.........................
..#..................................................#....#.................#####.#..#.....#.#......#..#...##..................#...
..#...........#.#......##..#.........##..#..#.................#......#.#.....#..#.#.#..........#......#....#......#.............##.
..............###....##......##..............#....##.#.........#...#..#...........#....#.....###............###..####.........#..#.
............#...#....#.............#..#.....#..#........#...#..##......#........#..#.............#...#..........................#..
..#.......................#....#....#......#.#..#..........#..#........#......#...#..........##.....#.#........#........#........#.
...................#....#..........##..#.##.........#..#..#...#.........#.....##.#.........#.#.#.#.............#...##..###.........
................#.#.....#.....#.#.................#.##.........#...#.....#...........#....##.....#....................##...........
...............#..........#.....#..#.....#.....###.#.#.......#..#..............#.................#...........#......###..#.........
...........#.......#..#............#.......#...#....#.#.#..#.#.#........#...##...#.....##.........##...#...........................
.........#..#..#..#..#..#....#...##.#..........#..#......#.#..................#......#......#...#..#.......#...#..........#........
.................................................................S.................................................................
......#.#........#......#......#.#...#.................#..........#.....#.#....#....##.........##...#..#..#....#..........#........
.......#.#.....................#####......#..............#........#.#......#...#..##.....................#.....##..#.......##......
..........#....###....#..............##....................#.#..........#...............#....#...#......#.....#..........#.........
..........#......#....#............#..#.#...#...#...............#....##......#..........##...#.........#...........................
.#...............#.....#.....#................#.......#.............#........#......##..#.....##..#...#..#....#....#....#..........
.......................#.......#.....#..#.##.........#.................#..#..#.#....#....###........#..........#.#....#..........#.
.................#.............#............#....#.#.....#...####..............#......#..#.#........#....##........................
............#.....#............#..#...#......#..#......#...............#.....#.......#...#..........#............................#.
.............#.#.........#.##...#.....#....................##...#..#..#..#..##.#...............#...##.........#....###.......#.....
................#.#....#...#...#...#.........#.....####............#..........#....#...............##...#..#..#....................
.......#...........#........##......#.......................................#...#..................................#.......#..#....
.#...#...........#........................#............#..............#.........#....#...#.......#...#.....#................#......
.#.#.#..#................#.#........................##.....................#........#....#..............#....#................#....
.#.....................#....#...#.#........##......#..#.#..##.............#.......#....#.#.........#..#.#..#....#..........##....#.
.....#..#...............#.........#.#..............#.........#.....#...........###..........#.#....##.#......#.....................
.#....#..#..#.......#......#..........#.....##.............#.#..#......#......#..............#....#......##...................#..#.
....#......................#.##..#........................................#.#.......#.........#....................................
....#...#..............#............#......#..........#...........................................#........#........#...#........#.
.#...#....#......................#......#....#.........#..#....#..........#.............##....#.#.#..##...............#......#.....
....#........#..........#........................#..#...........#....#...........#......#.......#.......#...........#........#.....
....#...#........................#.........#..#.#.#...#.#.......#.........#.#..............#......##.....#.........................
...#.#.....#......#.......#...................#...#.#.......#..#..#....#.........###.........#.........#..................#........
...........##....###............#..#.#.#........#.......#.#.#.#....#....#...#.......#..#........##..#..............................
........##.#.....#..#.......#.....#.......#...#..............#......................#.#........................#......#............
......#......#.#...............#...#...................#..............#....#.....#......#.#....................###.....#....#.#....
..................#.......................#.##................#.....#.......#.......................#.......#.##...#..........#....
..#..#....#.....#................#.....................................#........#..#......#..................##...###.#.....#....#.
........##...#...#.....#...................#....#........#...#..........#...#...............#.................#....#......##.#.....
...#....#......#.#............................#.#...#.....#........#....#..#.##..#..#...###................#......#....##......#...
....#.............#.#.........................#........#....#.#.........#.....#........#..#.....#.......#...#..#.........#...#..#..
.#........#.......#..##...#....................#.....#........#......#.#..#...##.......#.......#......................#...#...#....
..#........#.#....#.......#..........#...##...............#.......#.......#...........................#........#.....#.......#..##.
.#....##...#.....#.........#.........#.............#..#...............#...............................#...............#.#.#........
........#.............##..##............##...#.#...#.##.............#.#...#.....#.##...................#.....##....................
..#.......#....#.......##.##.#.........#.............................#.............#.##...............#....##.....#................
.#..#....#....##.#.#.#.......#.............#.........#......#...........#.............................................#............
....#.#..#...#.......#...#..#.#.##.........##...#....................................................#..........##...#...#.##......
.....................#........#..#.........##.................#.#................#..#................#....#..##.....#........#.....
............#......#...#....#...#................#..###........#.........#.........###.........#.....##........#..........##.......
..#.............................................##.....#....#...#.#...........#................#...............##......#...........
..........##..........##..........#.#........#......#.....#.#............#.........##...............#..............#.....#..#.#....
.............#..............#...#..#...........#.............#........#...........................#........#.##......#.............
.#.##.........####.#...#...#.........#.#............#.#.##..#..#..............#...............#.#.........#.#......#..#..#.#.....#.
...#........#.......................#................#..#...#..........#......................#...#.#.....#..........#.##...##.....
..................#...#.#..##...........#..................#.......#........#.................#.....#..........#...................
.......#..........#..............##.#..............#..#........##.#......#....#...........#....#..................##........#..##..
..............##......#.........#..#....#.#..............#.....#....#....##...#............#.#..#..#.#.........##..................
..................................#.......#..........##...#...............#...............#............#.#.......##.....#..#.###...
......#............#...#.................#................#.#..........#...............#.#..........#...##...#.#.#...#.......#...#.
............#.....#...................#.................#..#.#...........#.............#........#.#.................#........#.....
.#.............#..#.#.....#..#.............#..#................#....#.................#..#............#................#...........
.#.....#.#.......#...............#...................................#..#................#.....#.#......#...#.......#..........#...
........................##..#.....#..........##................#...#.............#..#.........##.......#.#.......#..#...##......#..
..#...#.......#.............#.........#.........#..........#..#........##............#.#.#.............#.#...#.#.#..#..............
.......###............#.#...............#.#..................#....#..............#............#..#.#.#......#.#.........#..#....#..
................#.........................#....#..................#.................#..#...................#.......#..#..###.......
........#.............#.................#..#..................................#..........#.#.......................................
........##.......#.....................#...........##..........................#...........#...#...#...#...#####...................
................#.............#..#....##.#....#..#.....#........#..........#.#.....#......#..#.....##......#...#...#...#.#....#....
.#..................#.#................#...#......#..#.#.................................................#.....#..........#........
.........#..#.........#.#.#............##........#.#........................#..................#...#..........#......#...#.......#.
....#......#.#..#..#.##...#....#.......##.........................................#.#.....##.##...#...........#..#....#..##....#...
...#.##.............#...#....#........#.....#...#...........................#.........#.......#.......#.#..#.#......##.............
...#...#..........#.....#.##...........#.......##........##.#.............#......#.##...........................#.....#...#.#......
...................................................................................................................................
"""
